<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CamperDispensa</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap');
  :root {
    --bg:#f5f6fa; --white:#fff; --text:#2d3436; --text2:#636e72; --text3:#b2bec3;
    --border:#e9ecef; --accent:#e17055; --green:#00b894; --yellow:#f0b429; --red:#e17055;
    --font:'Nunito',sans-serif;
  }
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
  body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;max-width:480px;margin:0 auto;overflow-x:hidden;}

  .hero{background:var(--white);text-align:center;padding:28px 20px 20px;border-bottom:1px solid var(--border);}
  .hero-label{font-size:13px;color:var(--text2);font-weight:600;margin-bottom:4px;}
  .hero-total{font-size:44px;font-weight:900;color:var(--accent);line-height:1;letter-spacing:-1px;}
  .hero-sub{font-size:13px;color:var(--text2);margin-top:4px;font-weight:600;}
  .hero-stats{display:flex;justify-content:center;gap:28px;margin-top:16px;}
  .hero-stat{text-align:center;}
  .hero-stat-num{font-size:22px;font-weight:900;line-height:1;}
  .hero-stat-num.ok{color:var(--green);}
  .hero-stat-num.warn{color:var(--yellow);}
  .hero-stat-num.miss{color:var(--red);}
  .hero-stat-label{font-size:11px;color:var(--text3);font-weight:700;margin-top:2px;}

  .top-tabs{background:var(--white);display:flex;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;}
  .top-tab{flex:1;padding:13px 4px;text-align:center;font-size:13px;font-weight:700;color:var(--text3);cursor:pointer;border-bottom:2.5px solid transparent;transition:all .2s;}
  .top-tab.active{color:var(--accent);border-bottom-color:var(--accent);}

  .content{padding:0 0 90px;}

  .cat-grid{display:grid;grid-template-columns:repeat(4,1fr);background:var(--white);padding:8px 0 4px;}
  .cat-cell{display:flex;flex-direction:column;align-items:center;padding:14px 4px 16px;cursor:pointer;transition:background .12s;position:relative;}
  .cat-cell:active,.cat-cell.selected{background:#fff8f7;}
  .cat-circle{width:62px;height:62px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;margin-bottom:8px;position:relative;transition:transform .15s;}
  .cat-cell:active .cat-circle{transform:scale(.93);}
  .cat-badge{position:absolute;top:0;right:0;background:var(--red);color:#fff;font-size:10px;font-weight:900;min-width:18px;height:18px;border-radius:9px;display:flex;align-items:center;justify-content:center;border:2px solid #fff;padding:0 3px;}
  .cat-count{font-size:13px;font-weight:800;line-height:1;}
  .cat-name{font-size:11px;color:var(--text2);font-weight:600;margin-top:3px;text-align:center;line-height:1.2;}
  .cat-missing{font-size:10px;color:var(--red);font-weight:700;margin-top:2px;}

  .section-divider{background:var(--bg);height:10px;}

  .prod-section{background:var(--white);margin-bottom:10px;}
  .prod-section-header{display:flex;align-items:center;padding:14px 18px 10px;gap:10px;}
  .prod-section-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;}
  .prod-section-title{font-size:15px;font-weight:800;flex:1;}
  .prod-section-count{font-size:12px;color:var(--text3);font-weight:700;}
  .prod-item{display:flex;align-items:center;padding:11px 18px;border-top:1px solid var(--border);cursor:pointer;gap:12px;transition:background .12s;}
  .prod-item:active{background:var(--bg);}
  .prod-item.disabled{opacity:.45;}
  .prod-item.disabled .prod-name{text-decoration:line-through;color:var(--text3);}
  .prod-item.disabled .prod-qty,.prod-item.disabled .prod-status-label{color:var(--text3)!important;}
  .prod-item.disabled .status-dot{background:var(--text3)!important;}
  .disabled-badge{font-size:10px;font-weight:800;color:var(--text3);background:var(--border);border-radius:6px;padding:2px 6px;margin-left:6px;vertical-align:middle;}
  .buy-badge{font-size:10px;font-weight:800;color:#fff;background:var(--accent);border-radius:6px;padding:2px 6px;margin-left:6px;vertical-align:middle;}
  .status-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
  .dot-ok{background:var(--green);}
  .dot-low{background:var(--yellow);}
  .dot-out{background:var(--red);}
  .prod-info{flex:1;min-width:0;}
  .prod-name{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .prod-note{font-size:11px;color:var(--text3);font-weight:600;margin-top:2px;}
  .prod-right{text-align:right;flex-shrink:0;}
  .prod-qty{font-size:14px;font-weight:800;}
  .prod-status-label{font-size:10px;font-weight:700;margin-top:2px;}
  .sl-ok{color:var(--green);}
  .sl-low{color:var(--yellow);}
  .sl-out{color:var(--red);}

  .empty{text-align:center;padding:36px 20px;}
  .empty-icon{font-size:44px;margin-bottom:10px;}
  .empty-text{font-size:14px;font-weight:700;color:var(--text2);}
  .empty-sub{font-size:12px;color:var(--text3);margin-top:4px;font-weight:600;}

  .spesa-add-bar{background:var(--white);padding:12px 16px;display:flex;gap:10px;border-bottom:1px solid var(--border);}
  .spesa-input{flex:1;background:var(--bg);border:1.5px solid var(--border);border-radius:12px;padding:10px 14px;font-family:var(--font);font-size:14px;font-weight:600;color:var(--text);outline:none;}
  .spesa-input:focus{border-color:var(--accent);}
  .spesa-add-btn{background:var(--accent);border:none;border-radius:12px;color:#fff;font-size:24px;width:46px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:var(--font);}
  .spesa-group{background:var(--white);margin-bottom:10px;}
  .spesa-group-header{padding:12px 18px 8px;font-size:11px;font-weight:800;color:var(--text3);letter-spacing:.8px;text-transform:uppercase;}
  .spesa-item{display:flex;align-items:center;padding:11px 18px;border-top:1px solid var(--border);gap:12px;}
  .checkbox{width:24px;height:24px;border-radius:8px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s;font-size:13px;font-weight:900;color:transparent;}
  .checkbox.checked{background:var(--green);border-color:var(--green);color:#fff;}
  .spesa-name{font-size:14px;font-weight:700;flex:1;}
  .spesa-name.done{text-decoration:line-through;color:var(--text3);}
  .spesa-cat{font-size:11px;color:var(--text3);margin-top:2px;font-weight:600;}
  .spesa-del{color:var(--text3);cursor:pointer;font-size:16px;padding:4px 6px;border-radius:8px;transition:all .12s;}
  .spesa-del:active{color:var(--red);}

  .settings-wrap{padding:14px 16px 20px;}
  .settings-label{font-size:11px;font-weight:800;color:var(--text3);letter-spacing:.8px;text-transform:uppercase;margin-bottom:8px;padding:0 4px;display:block;}
  .settings-card{background:var(--white);border-radius:16px;overflow:hidden;margin-bottom:20px;box-shadow:0 2px 12px rgba(0,0,0,.07);}
  .settings-row{display:flex;align-items:center;padding:14px 16px;gap:12px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .12s;}
  .settings-row:last-child{border-bottom:none;}
  .settings-row:active{background:var(--bg);}
  .settings-row-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;background:var(--bg);}
  .settings-row-text{flex:1;}
  .settings-row-title{font-size:14px;font-weight:700;}
  .settings-row-sub{font-size:11px;color:var(--text3);margin-top:2px;font-weight:600;}
  .settings-row-arrow{color:var(--text3);font-size:18px;}

  .fab{position:fixed;bottom:82px;right:20px;width:58px;height:58px;border-radius:50%;background:var(--accent);color:#fff;font-size:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(225,112,85,.45);z-index:1000;border:none;font-family:var(--font);transition:transform .15s;line-height:1;}
  .fab:active{transform:scale(.92);}

  .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:var(--white);border-top:1px solid var(--border);display:flex;z-index:500;box-shadow:0 -2px 10px rgba(0,0,0,.05);}
  .nav-item{flex:1;padding:8px 4px 12px;text-align:center;cursor:pointer;}
  .nav-icon{font-size:24px;display:block;}
  .nav-label{font-size:10px;font-weight:700;color:var(--text3);margin-top:2px;}
  .nav-item.active .nav-label{color:var(--accent);}

  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:2000;display:none;align-items:flex-end;opacity:0;pointer-events:none;transition:opacity .25s;}
  .modal-overlay.open{opacity:1;pointer-events:all;}
  .modal{background:var(--white);border-radius:24px 24px 0 0;padding:20px 20px 44px;width:100%;transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);max-height:92vh;overflow-y:auto;}
  .modal-overlay.open .modal{transform:translateY(0);}
  .modal-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 18px;}
  .modal-title{font-size:18px;font-weight:900;margin-bottom:18px;}

  .form-group{margin-bottom:13px;}
  .form-label{font-size:11px;font-weight:800;color:var(--text2);letter-spacing:.5px;text-transform:uppercase;margin-bottom:7px;display:block;}
  .form-input{width:100%;background:var(--bg);border:1.5px solid var(--border);border-radius:12px;padding:12px 14px;color:var(--text);font-family:var(--font);font-size:15px;font-weight:600;outline:none;transition:border-color .15s;-webkit-appearance:none;appearance:none;}
  .form-input:focus{border-color:var(--accent);}

  .status-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
  .status-opt{padding:11px 6px;border-radius:12px;border:1.5px solid var(--border);text-align:center;cursor:pointer;font-size:12px;font-weight:700;color:var(--text3);background:var(--bg);transition:all .15s;}
  .status-opt.sel-ok{border-color:var(--green);background:#e8f8f3;color:var(--green);}
  .status-opt.sel-low{border-color:var(--yellow);background:#fffbeb;color:#926b00;}
  .status-opt.sel-out{border-color:var(--red);background:#fff3f0;color:var(--red);}

  .btn-row{display:flex;gap:10px;margin-top:18px;}
  .btn{flex:1;padding:14px;border-radius:14px;font-family:var(--font);font-size:15px;font-weight:800;cursor:pointer;border:none;transition:transform .12s;}
  .btn:active{transform:scale(.97);}
  .btn-primary{background:var(--accent);color:#fff;}
  .btn-secondary{background:var(--bg);color:var(--text2);border:1.5px solid var(--border);}
  .btn-danger{background:#fff3f0;color:var(--red);border:1.5px solid #ffd5cc;width:100%;margin-top:8px;padding:13px;}

  .emoji-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-top:8px;}
  .emoji-opt{font-size:22px;text-align:center;padding:6px 4px;border-radius:8px;cursor:pointer;transition:background .12s;}
  .emoji-opt:active,.emoji-opt.sel{background:#fff0ee;}

  .hidden{display:none!important;}
  .persona-tab-disabled{opacity:.45;text-decoration:line-through;}

  /* VALIGIE */
  .valigia-card{background:var(--white);border-radius:16px;margin:10px 16px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.06);}
  .valigia-header{display:flex;align-items:center;padding:14px 16px;gap:12px;cursor:pointer;transition:background .12s;}
  .valigia-header:active{background:var(--bg);}
  .valigia-icon{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;}
  .valigia-info{flex:1;}
  .valigia-name{font-size:16px;font-weight:800;}
  .valigia-meta{font-size:11px;color:var(--text3);font-weight:600;margin-top:2px;}
  .valigia-active-badge{font-size:10px;font-weight:800;color:#fff;background:var(--green);border-radius:20px;padding:3px 10px;flex-shrink:0;}
  .valigia-inactive-badge{font-size:10px;font-weight:800;color:var(--text3);background:var(--border);border-radius:20px;padding:3px 10px;flex-shrink:0;}
  .valigia-toggle{width:44px;height:24px;border-radius:12px;position:relative;transition:background .2s;flex-shrink:0;cursor:pointer;}
  .valigia-knob{position:absolute;top:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);}
  .valigia-products{border-top:1px solid var(--border);}
  .valigia-prod-item{display:flex;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border);gap:10px;cursor:pointer;transition:background .12s;}
  .valigia-prod-item:last-child{border-bottom:none;}
  .valigia-prod-item:active{background:var(--bg);}
  .valigia-prod-item.disabled{opacity:.4;}
  .valigia-prod-name{font-size:13px;font-weight:700;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .valigia-prod-note{font-size:10px;color:var(--text3);font-weight:600;}
  .valigia-prod-right{text-align:right;flex-shrink:0;}
  .valigia-prod-status{font-size:10px;font-weight:800;}
  .valigia-section-header{padding:10px 16px 6px;font-size:10px;font-weight:800;color:var(--text3);letter-spacing:.8px;text-transform:uppercase;background:var(--bg);}
  .add-to-valigia-btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:12px;border-top:1px solid var(--border);font-size:13px;font-weight:700;color:var(--accent);cursor:pointer;background:var(--white);}
  .add-to-valigia-btn:active{background:var(--bg);}
</style>
</head>
<body>

<!-- INVENTARIO -->
<div id="view-inventario">
  <div class="hero">
    <div class="hero-label">Prodotti a bordo</div>
    <div class="hero-total" id="heroTotal">0</div>
    <div class="hero-sub" id="heroSub">prodotti in inventario</div>
    <div class="hero-stats">
      <div class="hero-stat"><div class="hero-stat-num ok" id="stat-ok">0</div><div class="hero-stat-label">‚úÖ OK</div></div>
      <div class="hero-stat"><div class="hero-stat-num warn" id="stat-low">0</div><div class="hero-stat-label">‚ö†Ô∏è Scarso</div></div>
      <div class="hero-stat"><div class="hero-stat-num miss" id="stat-out">0</div><div class="hero-stat-label">‚ùå Mancante</div></div>
    </div>
  </div>
  <div class="top-tabs">
    <div class="top-tab active" onclick="setInvView('categorie',this)">Categorie</div>
    <div class="top-tab" onclick="setInvView('prodotti',this)">Tutti i prodotti</div>
  </div>
  <div class="content">
    <div id="subview-categorie">
      <div class="cat-grid" id="catGrid"></div>
      <div class="section-divider"></div>
      <div id="filteredProducts"></div>
    </div>
    <div id="subview-prodotti" class="hidden">
      <div id="allProducts"></div>
    </div>
  </div>
</div>

<!-- LISTA SPESA -->
<div id="view-spesa" class="hidden">
  <div class="hero">
    <div class="hero-label">Lista della spesa</div>
    <div class="hero-total" id="spesaTotal" style="font-size:36px">0</div>
    <div class="hero-sub">articoli da acquistare</div>
  </div>
  <div class="top-tabs" style="top:0"><div class="top-tab active" style="cursor:default">Lista Spesa</div></div>
  <div class="content" style="padding-top:0">
    <div class="spesa-add-bar">
      <input class="spesa-input" id="quickSpesaInput" placeholder="Aggiungi voce manuale...">
      <button class="spesa-add-btn" onclick="addManualSpesa()">+</button>
    </div>
    <div id="spesaContent"></div>
  </div>
</div>

<!-- VALIGIE -->
<div id="view-valigie" class="hidden">
  <div class="hero">
    <div class="hero-label">Le mie valigie</div>
    <div class="hero-total" id="valigieHeroNum" style="font-size:36px">üß≥</div>
    <div class="hero-sub" id="valigieHeroSub">gestisci i tuoi bagagli</div>
  </div>
  <div id="personaSelectorBar" style="background:var(--white);padding:10px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;overflow-x:auto;scrollbar-width:none;">
    <div id="personaTabs" style="display:flex;gap:8px;flex:1;"></div>
    <div onclick="openPersonaManager()" style="width:32px;height:32px;border-radius:50%;background:var(--bg);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;flex-shrink:0;">‚öôÔ∏è</div>
  </div>
  <div class="top-tabs" style="top:0">
    <div class="top-tab active" onclick="setValigieView('lista',this)">Valigie</div>
    <div class="top-tab" onclick="setValigieView('mancanti',this)">Da preparare</div>
  </div>
  <div class="content" style="padding-top:0">
    <div id="subview-valigie-lista" style="padding:10px 0 0">
      <div id="valigieList"></div>
      <div style="padding:10px 16px 0">
        <div onclick="openNewValigiaModal()" style="display:flex;align-items:center;gap:12px;background:var(--white);border-radius:16px;padding:14px 16px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.06);">
          <div style="width:48px;height:48px;border-radius:50%;background:#f0fdf4;display:flex;align-items:center;justify-content:center;font-size:24px;">‚ûï</div>
          <div style="font-size:15px;font-weight:700;color:var(--accent)">Nuova valigia</div>
        </div>
      </div>
    </div>
    <div id="subview-valigie-mancanti" class="hidden" style="padding-top:0">
      <div id="valigieMancantiContent"></div>
    </div>
  </div>
</div>

<!-- DA PORTARE -->
<div id="view-portare" class="hidden">
  <div class="hero">
    <div class="hero-label">Da portare in camper</div>
    <div class="hero-total" id="portareTotal" style="font-size:36px">0</div>
    <div class="hero-sub">prodotti che hai gi√† a casa</div>
  </div>
  <div class="top-tabs" style="top:0"><div class="top-tab active" style="cursor:default">Da portare</div></div>
  <div class="content" style="padding-top:0">
    <div id="portareContent"></div>
  </div>
</div>

<!-- IMPOSTAZIONI -->
<div id="view-impostazioni" class="hidden">
  <div class="hero">
    <div class="hero-label">Impostazioni</div>
    <div class="hero-total" style="font-size:36px">‚öôÔ∏è</div>
    <div class="hero-sub">CamperDispensa v1.0</div>
  </div>
  <div class="settings-wrap">
    <span class="settings-label">Categorie</span>
    <div class="settings-card" id="catSettings"></div>
    <span class="settings-label">Dati</span>
    <div class="settings-card">
      <div class="settings-row" onclick="exportData()">
        <div class="settings-row-icon">üì§</div>
        <div class="settings-row-text"><div class="settings-row-title">Esporta dati</div><div class="settings-row-sub" id="lastBackupSub">Scarica backup JSON</div></div>
        <div class="settings-row-arrow">‚Ä∫</div>
      </div>
      <div class="settings-row" onclick="importTrigger()">
        <div class="settings-row-icon">üì•</div>
        <div class="settings-row-text"><div class="settings-row-title">Importa dati</div><div class="settings-row-sub">Ripristina da backup</div></div>
        <div class="settings-row-arrow">‚Ä∫</div>
      </div>
      <div class="settings-row" onclick="resetAll()">
        <div class="settings-row-icon">üóëÔ∏è</div>
        <div class="settings-row-text"><div class="settings-row-title">Reset completo</div><div class="settings-row-sub">Cancella tutti i dati</div></div>
        <div class="settings-row-arrow">‚Ä∫</div>
      </div>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <div class="nav-item active" onclick="switchTab('inventario')" id="nav-inventario">
    <span class="nav-icon">üì¶</span><div class="nav-label">Inventario</div>
  </div>
  <div class="nav-item" onclick="switchTab('spesa')" id="nav-spesa">
    <span class="nav-icon">üõí</span><div class="nav-label">Lista Spesa</div>
  </div>
  <div class="nav-item" onclick="switchTab('portare')" id="nav-portare">
    <span class="nav-icon">üè†</span><div class="nav-label">Da portare</div>
  </div>
  <div class="nav-item" onclick="switchTab('valigie')" id="nav-valigie">
    <span class="nav-icon">üß≥</span><div class="nav-label">Valigie</div>
  </div>
  <div class="nav-item" onclick="switchTab('impostazioni')" id="nav-impostazioni">
    <span class="nav-icon">‚öôÔ∏è</span><div class="nav-label">Impostazioni</div>
  </div>
</div>

<button class="fab" id="fabBtn" onclick="openAddModal()">+</button>

<!-- MODAL PRODOTTO -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modalTitle">Nuovo Prodotto</div>
    <div class="form-group">
      <label class="form-label">Nome prodotto</label>
      <input class="form-input" id="f-name" placeholder="Es. Pasta, Shampoo...">
    </div>
    <div class="form-group">
      <label class="form-label">Categoria</label>
      <select class="form-input" id="f-cat"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Quantit√†</label>
      <input class="form-input" id="f-qty" placeholder="Es. 2 pz, 500ml...">
    </div>
    <div class="form-group">
      <label class="form-label">Stato scorte</label>
      <div class="status-selector">
        <div class="status-opt sel-ok" onclick="selectStatus('ok',this)" id="sopt-ok">‚úÖ OK</div>
        <div class="status-opt" onclick="selectStatus('low',this)" id="sopt-low">‚ö†Ô∏è Scarso</div>
        <div class="status-opt" onclick="selectStatus('out',this)" id="sopt-out">‚ùå Mancante</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Note</label>
      <input class="form-input" id="f-note" placeholder="Marca, dove comprarlo...">
    </div>
    <div class="form-group">
      <label class="form-label">Da acquistare</label>
      <div onclick="toggleBuy()" style="display:flex;align-items:center;gap:12px;background:var(--bg);border:1.5px solid var(--border);border-radius:12px;padding:12px 14px;cursor:pointer;">
        <div style="flex:1">
          <div style="font-size:14px;font-weight:700;color:var(--text)" id="buyToggleLabel">Non da acquistare</div>
          <div style="font-size:11px;color:var(--text3);margin-top:2px;font-weight:600">Attiva se devi comprarlo</div>
        </div>
        <div id="buySwitch" style="width:44px;height:24px;border-radius:12px;background:var(--text3);position:relative;transition:background .2s;flex-shrink:0;">
          <div id="buyKnob" style="position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);"></div>
        </div>
      </div>
    </div>
    <div class="form-group" id="disabledToggleRow" style="display:none">
      <label class="form-label">Disponibilit√†</label>
      <div onclick="toggleDisabled()" style="display:flex;align-items:center;gap:12px;background:var(--bg);border:1.5px solid var(--border);border-radius:12px;padding:12px 14px;cursor:pointer;">
        <div style="flex:1">
          <div style="font-size:14px;font-weight:700;color:var(--text)" id="disabledToggleLabel">Prodotto attivo</div>
          <div style="font-size:11px;color:var(--text3);margin-top:2px;font-weight:600">Disattiva per prodotti stagionali</div>
        </div>
        <div id="toggleSwitch" style="width:44px;height:24px;border-radius:12px;background:var(--green);position:relative;transition:background .2s;flex-shrink:0;">
          <div id="toggleKnob" style="position:absolute;top:3px;left:23px;width:18px;height:18px;border-radius:50%;background:#fff;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);"></div>
        </div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeModal('modalOverlay')">Annulla</button>
      <button class="btn btn-primary" onclick="saveProduct()">Salva</button>
    </div>
    <div id="deleteBtnRow" style="display:none">
      <button class="btn btn-danger" onclick="deleteProduct()">üóëÔ∏è Elimina prodotto</button>
    </div>
  </div>
</div>

<!-- MODAL CATEGORIA -->
<div class="modal-overlay" id="catModalOverlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="catModalTitle">Modifica Categoria</div>
    <div class="form-group">
      <label class="form-label">Nome</label>
      <input class="form-input" id="cf-name" placeholder="Nome categoria">
    </div>
    <div class="form-group">
      <label class="form-label">Icona</label>
      <div style="font-size:36px;text-align:center;margin-bottom:8px" id="cf-icon-preview">üì¶</div>
      <div class="emoji-grid" id="emojiGrid"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeModal('catModalOverlay')">Annulla</button>
      <button class="btn btn-primary" onclick="saveCat()">Salva</button>
    </div>
    <div id="deleteCatBtnRow" style="display:none">
      <button class="btn btn-danger" onclick="deleteCat()">üóëÔ∏è Elimina categoria</button>
    </div>
  </div>
</div>

<!-- MODAL GESTIONE PERSONE -->
<div class="modal-overlay" id="personaManagerOverlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Gestione Persone</div>
    <div id="personaManagerList" style="margin-bottom:16px;display:flex;flex-direction:column;gap:8px;"></div>
    <button class="btn btn-primary" onclick="openNewPersonaModal()" style="width:100%;margin-bottom:0">‚ûï Nuova persona</button>
    <div class="btn-row" style="margin-top:10px">
      <button class="btn btn-secondary" onclick="closeModal('personaManagerOverlay')">Chiudi</button>
    </div>
  </div>
</div>

<!-- MODAL NUOVA/MODIFICA PERSONA -->
<div class="modal-overlay" id="personaEditOverlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="personaEditTitle">Nuova Persona</div>
    <div class="form-group">
      <label class="form-label">Nome</label>
      <input class="form-input" id="pe-nome" placeholder="Es. Marco, Sara...">
    </div>
    <div class="form-group">
      <label class="form-label">Colore</label>
      <div id="pe-colori" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:4px;"></div>
    </div>
    <div class="form-group" id="pe-disabled-row" style="display:none">
      <label class="form-label">Disponibilit√†</label>
      <div onclick="togglePersonaDisabled()" style="display:flex;align-items:center;gap:12px;background:var(--bg);border:1.5px solid var(--border);border-radius:12px;padding:12px 14px;cursor:pointer;">
        <div style="flex:1">
          <div style="font-size:14px;font-weight:700;color:var(--text)" id="peDisabledLabel">Persona attiva</div>
          <div style="font-size:11px;color:var(--text3);margin-top:2px;font-weight:600">Le valigie disattivate non compaiono</div>
        </div>
        <div id="peToggleSwitch" style="width:44px;height:24px;border-radius:12px;background:var(--green);position:relative;transition:background .2s;flex-shrink:0;">
          <div id="peToggleKnob" style="position:absolute;top:3px;left:23px;width:18px;height:18px;border-radius:50%;background:#fff;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);"></div>
        </div>
      </div>
    </div>
    <div class="form-group" id="pe-copia-row" style="display:none">
      <label class="form-label">Copia valigie da</label>
      <select class="form-input" id="pe-copia-da">
        <option value="">‚Äî Non copiare ‚Äî</option>
      </select>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeModal('personaEditOverlay')">Annulla</button>
      <button class="btn btn-primary" onclick="savePersona()">Salva</button>
    </div>
    <div id="deletePersonaBtnRow" style="display:none">
      <button class="btn btn-danger" onclick="deletePersona()">üóëÔ∏è Elimina persona</button>
    </div>
  </div>
</div>

<!-- MODAL VALIGIA -->
<div class="modal-overlay" id="valigiaModalOverlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="valigiaModalTitle">Nuova Valigia</div>
    <div class="form-group">
      <label class="form-label">Nome valigia</label>
      <input class="form-input" id="vm-name" placeholder="Es. Weekend Estate, Valigia grande...">
    </div>
    <div class="form-group">
      <label class="form-label">Icona</label>
      <div style="font-size:36px;text-align:center;margin-bottom:8px" id="vm-icon-preview">üß≥</div>
      <div class="emoji-grid" id="valigiaEmojiGrid"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeModal('valigiaModalOverlay')">Annulla</button>
      <button class="btn btn-primary" onclick="saveValigia()">Salva</button>
    </div>
    <div id="deleteValigiaBtnRow" style="display:none">
      <button class="btn btn-danger" onclick="deleteValigia()">üóëÔ∏è Elimina valigia</button>
    </div>
  </div>
</div>

<!-- MODAL PRODOTTO VALIGIA -->
<div class="modal-overlay" id="vProdModalOverlay">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="vProdModalTitle">Prodotto valigia</div>
    <div class="form-group">
      <label class="form-label">Nome</label>
      <input class="form-input" id="vp-name" placeholder="Es. Spazzolino, Pigiama...">
    </div>
    <div class="form-group">
      <label class="form-label">Note / Dettagli</label>
      <input class="form-input" id="vp-note" placeholder="Es. quantit√†, colore...">
    </div>
    <div class="form-group">
      <label class="form-label">Stato</label>
      <div class="status-selector">
        <div class="status-opt sel-ok" onclick="selectVPStatus('ok',this)" id="vpsopt-ok">‚úÖ OK</div>
        <div class="status-opt" onclick="selectVPStatus('low',this)" id="vpsopt-low">‚ö†Ô∏è Scarso</div>
        <div class="status-opt" onclick="selectVPStatus('out',this)" id="vpsopt-out">‚ùå Mancante</div>
      </div>
    </div>
    <div class="form-group" id="vpDisabledToggleRow" style="display:none">
      <label class="form-label">Disponibilit√†</label>
      <div onclick="toggleVPDisabled()" style="display:flex;align-items:center;gap:12px;background:var(--bg);border:1.5px solid var(--border);border-radius:12px;padding:12px 14px;cursor:pointer;">
        <div style="flex:1">
          <div style="font-size:14px;font-weight:700;color:var(--text)" id="vpDisabledLabel">Prodotto attivo</div>
          <div style="font-size:11px;color:var(--text3);margin-top:2px;font-weight:600">Disattiva per prodotti stagionali</div>
        </div>
        <div id="vpToggleSwitch" style="width:44px;height:24px;border-radius:12px;background:var(--green);position:relative;transition:background .2s;flex-shrink:0;">
          <div id="vpToggleKnob" style="position:absolute;top:3px;left:23px;width:18px;height:18px;border-radius:50%;background:#fff;transition:left .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);"></div>
        </div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Presente in queste valigie</label>
      <div id="vp-valigie-checks" style="display:flex;flex-direction:column;gap:8px;"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeModal('vProdModalOverlay')">Annulla</button>
      <button class="btn btn-primary" onclick="saveVProd()">Salva</button>
    </div>
    <div id="deleteVProdBtnRow" style="display:none">
      <button class="btn btn-danger" onclick="deleteVProd()">üóëÔ∏è Elimina prodotto</button>
    </div>
  </div>
</div>

<input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">

<script>
const DEFAULT_CATEGORIES = [
  {id:'bagno',      name:'Bagno',            icon:'üöø', color:'#A855F7', bg:'#faf0ff'},
  {id:'detersivi',  name:'Detersivi',         icon:'üß¥', color:'#4DA6FF', bg:'#f0f6ff'},
  {id:'biancheria', name:'Biancheria',        icon:'üõèÔ∏è', color:'#06B6D4', bg:'#f0fbff'},
  {id:'dispensa',   name:'Dispensa',          icon:'ü•´', color:'#FF6B6B', bg:'#fff0f0'},
  {id:'attrezzatura',name:'Attrezzatura',     icon:'üîß', color:'#F59E0B', bg:'#fffbeb'},
  {id:'varie',      name:'Varie',             icon:'üì¶', color:'#6B7280', bg:'#f3f4f6'},
  {id:'dacasa',     name:'Da casa',           icon:'üè†', color:'#10B981', bg:'#ecfdf5'},
  {id:'dagarage',   name:'Da garage',         icon:'ü™õ', color:'#8B5CF6', bg:'#f5f3ff'},
];

const DEFAULT_PRODUCTS = [
  // Bagno
  {name:'Gel/cera capelli',   cat:'bagno'},
  {name:'Deodorante',         cat:'bagno'},
  {name:'Shampoo',            cat:'bagno'},
  {name:'Bagnoschiuma',       cat:'bagno'},
  {name:'Spazzolini',         cat:'bagno'},
  {name:'Dentifricio',        cat:'bagno'},
  {name:'Carta igienica',     cat:'bagno'},
  {name:'Prep',               cat:'bagno'},
  // Detersivi
  {name:'Alcool',             cat:'detersivi'},
  {name:'Acquakem nere',      cat:'detersivi'},
  {name:'Acquakem grigie',    cat:'detersivi'},
  {name:'Sgrassatore',        cat:'detersivi'},
  {name:'Detersivo piatti',   cat:'detersivi'},
  {name:'Detersivo panni',    cat:'detersivi'},
  {name:'Sacchetti spazzatura',cat:'detersivi'},
  {name:'Guanti',             cat:'detersivi'},
  // Biancheria
  {name:'Tovaglia',           cat:'biancheria'},
  {name:'Canovacci cucina',   cat:'biancheria'},
  {name:'Copri materasso',    cat:'biancheria'},
  {name:'Lenzuola',           cat:'biancheria'},
  {name:'Accappatoi',         cat:'biancheria'},
  {name:'Asciugamani',        cat:'biancheria'},
  {name:'Teli microfibra bagno',cat:'biancheria'},
  // Dispensa
  {name:'Caff√® normale',      cat:'dispensa'},
  {name:'Caff√® decaffeinato', cat:'dispensa'},
  {name:'Stecchette caff√®',   cat:'dispensa'},
  {name:'Tovaglioli',         cat:'dispensa'},
  {name:'Fazzolettini',       cat:'dispensa'},
  {name:'Bicchieri',          cat:'dispensa'},
  {name:'Bicchierini caff√®',  cat:'dispensa'},
  {name:'Piatti di plastica', cat:'dispensa'},
  {name:'Olio',               cat:'dispensa'},
  {name:'Sale grosso',        cat:'dispensa'},
  {name:'Sale fino',          cat:'dispensa'},
  {name:'Bustine zucchero di canna', cat:'dispensa'},
  {name:'Bustine zucchero bianco',   cat:'dispensa'},
  {name:'Spezie',             cat:'dispensa'},
  {name:'Acqua',              cat:'dispensa'},
  // Attrezzatura
  {name:'Barbeque',           cat:'attrezzatura'},
  {name:'Griglia barbeque',   cat:'attrezzatura'},
  {name:'Carbonella',         cat:'attrezzatura'},
  // Varie
  {name:'Liquido antizanzare',cat:'varie'},
  {name:'Lampade da tavolo',  cat:'varie'},
  {name:'Cellulare connessione',cat:'varie'},
  {name:'Condizionatore/termosifone',cat:'varie'},
  {name:'Aspirapolvere',      cat:'varie'},
  // Da casa
  {name:'Libretto',           cat:'dacasa'},
  {name:'Chiavi',             cat:'dacasa'},
  {name:'Telepass',           cat:'dacasa'},
  {name:'Occhiali da vista',  cat:'dacasa'},
  {name:'Occhiali da sole',   cat:'dacasa'},
  {name:'Fire stick + telecomando', cat:'dacasa'},
  {name:'Gopro',              cat:'dacasa'},
  // Da garage
  {name:'Caricabatterie scooter', cat:'dagarage'},
  {name:'Cavo ricarica tipo 2',   cat:'dagarage'},
  {name:'Lucchetto caricabatterie',cat:'dagarage'},
  {name:'Attrezzi',           cat:'dagarage'},
  {name:'Amache',             cat:'dagarage'},
  {name:'Frigo elettrico',    cat:'dagarage'},
  {name:'Avvitatore',         cat:'dagarage'},
  {name:'Impermeabili givova',cat:'dagarage'},
  {name:'Pinne e attrezzatura mare', cat:'dagarage'},
];

const PERSONE_DEFAULT = [
  {id:'p1', nome:'Persona 1', colore:'#e17055', bg:'#fff3f0'},
  {id:'p2', nome:'Persona 2', colore:'#4DA6FF', bg:'#f0f6ff'},
];

const VALIGIE_DEFAULT = [
  {id:'v_inverno',  name:'Weekend Inverno',  icon:'üß≥', color:'#4DA6FF', bg:'#f0f6ff', active:false, personaId:'p1'},
  {id:'v_estate',   name:'Weekend Estate',   icon:'‚òÄÔ∏è', color:'#FF6B6B', bg:'#fff0f0', active:false, personaId:'p1'},
  {id:'v_primavera',name:'Weekend Primavera',icon:'üå∏', color:'#22C55E', bg:'#f0fdf4', active:false, personaId:'p1'},
  {id:'v_autunno',  name:'Weekend Autunno',  icon:'üçÇ', color:'#F59E0B', bg:'#fffbeb', active:false, personaId:'p1'},
  {id:'v_grande',   name:'Vacanza Estiva',   icon:'üèñÔ∏è', color:'#06B6D4', bg:'#f0fbff', active:false, personaId:'p1'},
];

// Prodotti valigie: ogni prodotto ha valigie:[] con gli id delle valigie a cui appartiene
const VALIGIE_PROD_DEFAULT = [
  // Condivisi weekend
  {id:'vp_mutande',    name:'Mutande',               note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''},{id:'v_estate',qty:''},{id:'v_primavera',qty:''},{id:'v_autunno',qty:''},{id:'v_grande',qty:''}]},
  {id:'vp_calzini',    name:'Calzini',               note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''},{id:'v_primavera',qty:''},{id:'v_autunno',qty:''},{id:'v_grande',qty:''}]},
  {id:'vp_magliette',  name:'Magliette',             note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''},{id:'v_primavera',qty:''},{id:'v_autunno',qty:''}]},
  {id:'vp_tshirt',     name:'T-shirt',               note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''},{id:'v_estate',qty:''}]},
  {id:'vp_costume',    name:'Costume mare',          note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''},{id:'v_primavera',qty:''},{id:'v_autunno',qty:''}]},
  {id:'vp_scarpe',     name:'Scarpe',                note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''},{id:'v_primavera',qty:''},{id:'v_autunno',qty:''}]},
  {id:'vp_carica',     name:'Caricabatterie cellulare',note:'',status:{p1:'ok',p2:'ok'},valigie:[{id:'v_inverno',qty:''},{id:'v_estate',qty:''},{id:'v_primavera',qty:''},{id:'v_autunno',qty:''},{id:'v_grande',qty:''}]},
  {id:'vp_borsello',   name:'Borsello bagno',        note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''},{id:'v_estate',qty:''},{id:'v_primavera',qty:''},{id:'v_autunno',qty:''},{id:'v_grande',qty:''}]},
  {id:'vp_medicine',   name:'Borsa medicine',        note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''},{id:'v_estate',qty:''},{id:'v_primavera',qty:''},{id:'v_autunno',qty:''},{id:'v_grande',qty:''}]},
  {id:'vp_accappatoio',name:'Accappatoio terme',     note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''},{id:'v_estate',qty:''},{id:'v_primavera',qty:''},{id:'v_autunno',qty:''}]},
  {id:'vp_pantaloncini',name:'Pantaloncini',         note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_estate',qty:''},{id:'v_primavera',qty:''},{id:'v_autunno',qty:''},{id:'v_grande',qty:''}]},
  {id:'vp_pantaloni',  name:'Pantaloni',             note:'', status:{p1:'out',p2:'out'},valigie:[{id:'v_primavera',qty:''},{id:'v_autunno',qty:''},{id:'v_grande',qty:''}]},
  // Solo inverno
  {id:'vp_infradito',  name:'Infradito spa',         note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''}]},
  {id:'vp_tuta',       name:'Tuta',                  note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''}]},
  {id:'vp_pigiama',    name:'Pigiama',               note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''},{id:'v_grande',qty:''}]},
  {id:'vp_cappello',   name:'Cappello',              note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''}]},
  {id:'vp_calzettoni', name:'Calzettoni',            note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''}]},
  {id:'vp_intimi',     name:'Magliette intime',      note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''}]},
  {id:'vp_maglioncini',name:'Maglioncini',           note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''}]},
  {id:'vp_trekking',   name:'Scarpe da trekking',    note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''}]},
  {id:'vp_telo_micro', name:'Telo microfibra',       note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_inverno',qty:''}]},
  // Solo estate
  {id:'vp_tshirt_mare',name:'T-shirt mare',          note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_estate',qty:''}]},
  {id:'vp_jeans',      name:'Jeans',                 note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_estate',qty:''}]},
  {id:'vp_pant_tuta',  name:'Pantaloni tuta',        note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_estate',qty:''}]},
  {id:'vp_giacca_tuta',name:'Giacca tuta',           note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_estate',qty:''}]},
  {id:'vp_scarpe_e',   name:'Scarpe',                note:'', status:{p1:'out',p2:'out'},valigie:[{id:'v_estate',qty:''}]},
  {id:'vp_giacca_leg', name:'Giacca leggera',        note:'', status:{p1:'out',p2:'out'},valigie:[{id:'v_estate',qty:''}]},
  // Solo grande
  {id:'vp_auric_filo', name:'Auricolari filo',       note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_grande',qty:''}]},
  {id:'vp_auric_bt',   name:'Auricolare bluetooth',  note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_grande',qty:''}]},
  {id:'vp_cintura',    name:'Cintura',               note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_grande',qty:''}]},
  {id:'vp_tuta_giv',   name:'Tuta Givova',           note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_grande',qty:''}]},
  {id:'vp_accappatoi', name:'Accappatoi',            note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_grande',qty:''}]},
  {id:'vp_cuffia',     name:'Cuffia piscina',        note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_grande',qty:''}]},
  {id:'vp_costumi_g',  name:'Costumi mare e piscina',note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_grande',qty:''}]},
  {id:'vp_asciug_micro',name:'Asciugamani microfibra',note:'',status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_grande',qty:''}]},
  {id:'vp_asciug_bagno',name:'Asciugamani bagno',   note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_grande',qty:''}]},
  {id:'vp_teli_mare',  name:'Teli mare',             note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_grande',qty:''}]},
  {id:'vp_regolabarba',name:'Regolabarba con caricabatterie',note:'',status:{p1:'ok',p2:'ok'},valigie:[{id:'v_grande',qty:''}]},
  {id:'vp_deodorante', name:'Deodorante e profumo',  note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_grande',qty:''}]},
  {id:'vp_lametta',    name:'Lametta barba',         note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_grande',qty:''}]},
  {id:'vp_sapone_b',   name:'Sapone barba',          note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_grande',qty:''}]},
  {id:'vp_pennello_b', name:'Pennello barba',        note:'', status:{p1:'ok',p2:'ok'}, valigie:[{id:'v_grande',qty:''}]},
];

const EMOJIS = ['ü•´','üçï','üçû','ü•©','üßÉ','‚òï','üç´','ü•ö','üßÑ','üçé',
                'üß¥','üßπ','ü™£','üßΩ','ü´ß','ü™•','üõÅ','üöø','ü™í','üíä',
                'üõèÔ∏è','ü™°','üëï','üß£','üèïÔ∏è','ü™ë','üî¶','üîß','‚õ∫','üó∫Ô∏è',
                'üçΩÔ∏è','ü•Ñ','üî™','üì¶','üéí','üöê','üè†','ü™õ','üî©','üß∞',
                'üèñÔ∏è','ü§ø','üé£','üåä','‚õµ','üèÑ','üö¥','üõµ','üöó','‚úàÔ∏è'];

let products=[], spesaManuale=[], categories=[], valigie=[], valigieProdotti=[], persone=[];
let currentTab='inventario', currentInvView='categorie', currentValigieView='lista';
let selectedCat=null, editingId=null, editingCatId=null, selectedStatus='ok', selectedEmoji=null;
let isNewCat=false;
let editingValigiaId=null, editingVProdId=null, editingVProdValigiaId=null, selectedVPStatus='ok';
let currentPersonaId='p1', editingPersonaId=null;

function save() {
  localStorage.setItem('cd_products', JSON.stringify(products));
  localStorage.setItem('cd_spesa', JSON.stringify(spesaManuale));
  localStorage.setItem('cd_categories', JSON.stringify(categories));
  localStorage.setItem('cd_valigie', JSON.stringify(valigie));
  localStorage.setItem('cd_valigie_prod', JSON.stringify(valigieProdotti));
  localStorage.setItem('cd_persone', JSON.stringify(persone));
}

function load() {
  try {
    const savedCats = JSON.parse(localStorage.getItem('cd_categories')||'null');
    categories = savedCats ? savedCats : JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
    const savedProds = JSON.parse(localStorage.getItem('cd_products')||'null');
    if (savedProds !== null) {
      products = savedProds;
    } else {
      // Prima volta: carica prodotti predefiniti tutti OK
      let id = Date.now();
      products = DEFAULT_PRODUCTS.map(p => ({
        id: id++, name: p.name, cat: p.cat, qty: '', note: '', status: 'ok'
      }));
    }
    spesaManuale = JSON.parse(localStorage.getItem('cd_spesa')||'[]');
    const savedValigie = JSON.parse(localStorage.getItem('cd_valigie')||'null');
    valigie = savedValigie ? savedValigie : JSON.parse(JSON.stringify(VALIGIE_DEFAULT));
    const savedVP = JSON.parse(localStorage.getItem('cd_valigie_prod')||'null');
    valigieProdotti = savedVP ? savedVP : JSON.parse(JSON.stringify(VALIGIE_PROD_DEFAULT));
    const savedPersone = JSON.parse(localStorage.getItem('cd_persone')||'null');
    persone = savedPersone ? savedPersone : JSON.parse(JSON.stringify(PERSONE_DEFAULT));
    // Assicura che tutte le valigie abbiano personaId
    valigie.forEach(v=>{ if(!v.personaId) v.personaId='p1'; });
    // currentPersonaId alla prima persona
    if(persone.length) currentPersonaId = persone[0].id;
  } catch(e) {
    categories = JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
    products = []; spesaManuale = [];
    valigie = JSON.parse(JSON.stringify(VALIGIE_DEFAULT));
    valigieProdotti = JSON.parse(JSON.stringify(VALIGIE_PROD_DEFAULT));
    persone = JSON.parse(JSON.stringify(PERSONE_DEFAULT));
  }
}

function getCat(id) { return categories.find(c=>c.id===id)||{id:'?',name:'?',icon:'üì¶',color:'#999',bg:'#eee'}; }

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function switchTab(tab) {
  currentTab=tab;
  ['inventario','valigie','portare','spesa','impostazioni'].forEach(t=>{
    document.getElementById('view-'+t).classList.toggle('hidden', t!==tab);
    document.getElementById('nav-'+t).classList.toggle('active', t===tab);
  });
  document.getElementById('fabBtn').style.display = (tab==='inventario') ? 'flex' : 'none';
  if(tab==='inventario') renderInventario();
  if(tab==='valigie') renderValigie();
  if(tab==='portare') renderPortare();
  if(tab==='spesa') renderSpesa();
  if(tab==='impostazioni') renderSettings();
}

function setInvView(v, el) {
  currentInvView=v; selectedCat=null;
  document.querySelectorAll('.top-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('subview-categorie').classList.toggle('hidden', v!=='categorie');
  document.getElementById('subview-prodotti').classList.toggle('hidden', v!=='prodotti');
  renderInventario();
}

// ‚îÄ‚îÄ INVENTARIO ‚îÄ‚îÄ
function renderInventario() {
  const ok=products.filter(p=>p.status==='ok'&&!p.disabled).length;
  const low=products.filter(p=>p.status==='low'&&!p.disabled).length;
  const out=products.filter(p=>p.status==='out'&&!p.disabled).length;
  document.getElementById('stat-ok').textContent=ok;
  document.getElementById('stat-low').textContent=low;
  document.getElementById('stat-out').textContent=out;
  document.getElementById('heroTotal').textContent=products.length;
  document.getElementById('heroSub').textContent=products.length===1?'prodotto in inventario':'prodotti in inventario';
  if(currentInvView==='categorie'){renderCatGrid();renderFiltered();}
  else renderAllProducts();
}

function renderCatGrid() {
  document.getElementById('catGrid').innerHTML = categories.map(cat=>{
    const count=products.filter(p=>p.cat===cat.id).length;
    const missing=products.filter(p=>p.cat===cat.id&&(p.status==='out'||p.status==='low')&&!p.disabled).length;
    const active=selectedCat===cat.id;
    return `<div class="cat-cell${active?' selected':''}" onclick="selectCat('${cat.id}')">
      <div class="cat-circle" style="background:${cat.bg}">
        <span>${cat.icon}</span>
        ${missing>0?`<div class="cat-badge">${missing}</div>`:''}
      </div>
      <div class="cat-count" style="color:${cat.color}">${count} pz</div>
      <div class="cat-name">${cat.name}</div>
      ${missing>0?`<div class="cat-missing">${missing} mancanti</div>`:''}
    </div>`;
  }).join('');
}

function selectCat(id) {
  selectedCat = selectedCat===id ? null : id;
  renderCatGrid(); renderFiltered();
  if(selectedCat) setTimeout(()=>document.getElementById('filteredProducts').scrollIntoView({behavior:'smooth'}),50);
}

function renderFiltered() {
  const el=document.getElementById('filteredProducts');
  if(!selectedCat){el.innerHTML='';return;}
  const cat=getCat(selectedCat);
  const items=products.filter(p=>p.cat===selectedCat).sort((a,b)=>({out:0,low:1,ok:2}[a.status]-{out:0,low:1,ok:2}[b.status]));
  el.innerHTML=`<div class="prod-section">
    <div class="prod-section-header">
      <div class="prod-section-icon" style="background:${cat.bg}">${cat.icon}</div>
      <div class="prod-section-title">${cat.name}</div>
      <div class="prod-section-count">${items.length} prodotti</div>
    </div>
    ${items.length===0
      ?`<div class="empty"><div class="empty-icon">üì≠</div><div class="empty-text">Nessun prodotto</div><div class="empty-sub">Tocca + per aggiungere</div></div>`
      :items.map(productRow).join('')}
  </div>`;
}

function renderAllProducts() {
  const el=document.getElementById('allProducts');
  if(!products.length){
    el.innerHTML=`<div style="background:white"><div class="empty"><div class="empty-icon">üì¶</div><div class="empty-text">Inventario vuoto</div><div class="empty-sub">Tocca + per aggiungere il primo prodotto</div></div></div>`;
    return;
  }
  let html='';
  categories.forEach(cat=>{
    const items=products.filter(p=>p.cat===cat.id).sort((a,b)=>({out:0,low:1,ok:2}[a.status]-{out:0,low:1,ok:2}[b.status]));
    if(!items.length) return;
    html+=`<div class="prod-section">
      <div class="prod-section-header">
        <div class="prod-section-icon" style="background:${cat.bg}">${cat.icon}</div>
        <div class="prod-section-title">${cat.name}</div>
        <div class="prod-section-count">${items.length}</div>
      </div>
      ${items.map(productRow).join('')}
    </div>`;
  });
  el.innerHTML=html;
}

function productRow(p) {
  const dc=p.status==='ok'?'dot-ok':p.status==='low'?'dot-low':'dot-out';
  const sc=p.status==='ok'?'sl-ok':p.status==='low'?'sl-low':'sl-out';
  const sl=p.status==='ok'?'OK':p.status==='low'?'Scarso':'Mancante';
  const dis=p.disabled?' disabled':'';
  return `<div class="prod-item${dis}" onclick="openEditModal(${p.id})">
    <div class="status-dot ${dc}"></div>
    <div class="prod-info">
      <div class="prod-name">${p.name}${p.disabled?'<span class="disabled-badge">DISATTIVO</span>':p.toBuy?'<span class="buy-badge">DA ACQUISTARE</span>':''}</div>
      ${p.note?`<div class="prod-note">${p.note}</div>`:''}
    </div>
    <div class="prod-right">
      <div class="prod-qty ${sc}">${p.qty||'‚Äî'}</div>
      <div class="prod-status-label ${sc}">${sl}</div>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ SPESA ‚îÄ‚îÄ
function renderSpesa() {
  const auto=products.filter(p=>p.toBuy&&!p.disabled);
  const pending=spesaManuale.filter(s=>!s.done).length;
  document.getElementById('spesaTotal').textContent=auto.length+pending;
  let html='';
  if(auto.length){
    html+=`<div class="spesa-group"><div class="spesa-group-header">DA INVENTARIO ‚Äî MANCANTI / SCARSI</div>`;
    html+=auto.map(p=>{
      const cat=getCat(p.cat);
      return `<div class="spesa-item">
        <div class="checkbox" id="chk-${p.id}" onclick="toggleAuto(${p.id},this)"></div>
        <div style="flex:1">
          <div class="spesa-name" id="sname-${p.id}">${p.status==='out'?'‚ùå':'‚ö†Ô∏è'} ${p.name}</div>
          <div class="spesa-cat">${cat.icon} ${cat.name}${p.qty?' ¬∑ '+p.qty:''}</div>
        </div>
        <div class="spesa-del" onclick="openEditModal(${p.id})">‚úèÔ∏è</div>
      </div>`;
    }).join('');
    html+='</div>';
  }
  if(spesaManuale.length){
    html+=`<div class="spesa-group"><div class="spesa-group-header">AGGIUNTE MANUALI</div>`;
    html+=spesaManuale.map((s,i)=>`<div class="spesa-item">
      <div class="checkbox${s.done?' checked':''}" onclick="toggleManual(${i})">${s.done?'‚úì':''}</div>
      <div style="flex:1">
        <div class="spesa-name${s.done?' done':''}">${s.name}</div>
        <div class="spesa-cat">üõí Aggiunta manuale</div>
      </div>
      <div class="spesa-del" onclick="removeManual(${i})">‚úï</div>
    </div>`).join('');
    html+='</div>';
  }
  if(!html) html=`<div style="background:white"><div class="empty"><div class="empty-icon">üõí</div><div class="empty-text">Lista vuota!</div><div class="empty-sub">Segna prodotti come mancanti o scarsi<br>oppure aggiungi voci manuali sopra</div></div></div>`;
  document.getElementById('spesaContent').innerHTML=html;
}

function toggleAuto(pid,el){
  el.classList.toggle('checked'); el.textContent=el.classList.contains('checked')?'‚úì':'';
  const n=document.getElementById('sname-'+pid); if(n) n.classList.toggle('done');
}
function addManualSpesa(){
  const inp=document.getElementById('quickSpesaInput'); const v=inp.value.trim(); if(!v) return;
  spesaManuale.push({name:v,done:false}); inp.value=''; save(); renderSpesa();
}
function toggleManual(i){spesaManuale[i].done=!spesaManuale[i].done;save();renderSpesa();}
function removeManual(i){spesaManuale.splice(i,1);save();renderSpesa();}

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ
function renderSettings(){
  const lastBackup = localStorage.getItem('cd_last_backup');
  const subEl = document.getElementById('lastBackupSub');
  if(subEl && lastBackup){
    const d = new Date(parseInt(lastBackup));
    const dateStr = d.toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});
    const timeStr = d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
    subEl.textContent = 'Ultimo backup: '+dateStr+' alle '+timeStr;
  }
  document.getElementById('catSettings').innerHTML=
    categories.map(c=>{
      const n=products.filter(p=>p.cat===c.id).length;
      const m=products.filter(p=>p.cat===c.id&&(p.status==='out'||p.status==='low')).length;
      return `<div class="settings-row" onclick="openCatModal('${c.id}')">
        <div class="settings-row-icon" style="background:${c.bg}">${c.icon}</div>
        <div class="settings-row-text">
          <div class="settings-row-title">${c.name}</div>
          <div class="settings-row-sub">${n} prodotti${m>0?' ¬∑ <span style="color:var(--red)">'+m+' da comprare</span>':''}</div>
        </div>
        <div class="settings-row-arrow">‚Ä∫</div>
      </div>`;
    }).join('')
    + `<div class="settings-row" onclick="openNewCatModal()">
        <div class="settings-row-icon" style="background:#f0fdf4">‚ûï</div>
        <div class="settings-row-text">
          <div class="settings-row-title">Aggiungi categoria</div>
          <div class="settings-row-sub">Crea una nuova categoria</div>
        </div>
        <div class="settings-row-arrow">‚Ä∫</div>
      </div>`;
}

// ‚îÄ‚îÄ MODAL PRODOTTO ‚îÄ‚îÄ
function openAddModal(){
  editingId=null;
  document.getElementById('modalTitle').textContent='Nuovo Prodotto';
  document.getElementById('f-name').value='';
  document.getElementById('f-qty').value='';
  document.getElementById('f-note').value='';
  document.getElementById('deleteBtnRow').style.display='none';
  document.getElementById('disabledToggleRow').style.display='none';
  setBuyUI(false);
  selectStatus('ok',document.getElementById('sopt-ok'));
  const sel=document.getElementById('f-cat');
  sel.innerHTML=categories.map(c=>`<option value="${c.id}">${c.icon} ${c.name}</option>`).join('');
  if(selectedCat) sel.value=selectedCat;
  openModal('modalOverlay');
  setTimeout(()=>document.getElementById('f-name').focus(),350);
}

function openEditModal(id){
  const p=products.find(x=>x.id===id); if(!p) return;
  editingId=id;
  document.getElementById('modalTitle').textContent='Modifica Prodotto';
  document.getElementById('f-name').value=p.name;
  document.getElementById('f-qty').value=p.qty||'';
  document.getElementById('f-note').value=p.note||'';
  const sel=document.getElementById('f-cat');
  sel.innerHTML=categories.map(c=>`<option value="${c.id}">${c.icon} ${c.name}</option>`).join('');
  sel.value=p.cat;
  selectStatus(p.status,document.getElementById('sopt-'+p.status));
  document.getElementById('deleteBtnRow').style.display='block';
  document.getElementById('disabledToggleRow').style.display='block';
  setToggleUI(!p.disabled);
  setBuyUI(!!p.toBuy);
  openModal('modalOverlay');
}

function saveProduct(){
  const name=document.getElementById('f-name').value.trim();
  if(!name){document.getElementById('f-name').style.borderColor='var(--red)';return;}
  document.getElementById('f-name').style.borderColor='';
  const cat=document.getElementById('f-cat').value;
  const qty=document.getElementById('f-qty').value.trim();
  const note=document.getElementById('f-note').value.trim();
  if(editingId!==null){
    const p=products.find(x=>x.id===editingId);
    if(p) Object.assign(p,{name,cat,qty,note,status:selectedStatus,disabled:currentDisabled,toBuy:currentBuy});
  } else {
    products.unshift({id:Date.now(),name,cat,qty,note,status:selectedStatus,disabled:false,toBuy:false});
  }
  save(); closeModal('modalOverlay');
  if(currentTab==='inventario') renderInventario();
  if(currentTab==='spesa') renderSpesa();
}

function deleteProduct(){
  if(!confirm('Eliminare questo prodotto?')) return;
  products=products.filter(p=>p.id!==editingId);
  save(); closeModal('modalOverlay'); renderInventario();
}

let currentDisabled = false;
let currentBuy = false;

function setBuyUI(active){
  currentBuy = active;
  const sw = document.getElementById('buySwitch');
  const kn = document.getElementById('buyKnob');
  const lb = document.getElementById('buyToggleLabel');
  if(active){
    sw.style.background='var(--accent)';
    kn.style.left='23px';
    lb.textContent='Da acquistare üõí';
    lb.style.color='var(--accent)';
  } else {
    sw.style.background='var(--text3)';
    kn.style.left='3px';
    lb.textContent='Non da acquistare';
    lb.style.color='var(--text)';
  }
}

function toggleBuy(){ setBuyUI(!currentBuy); }

function renderPortare(){
  const items = products.filter(p=>(p.status==='out'||p.status==='low')&&!p.toBuy&&!p.disabled);
  document.getElementById('portareTotal').textContent = items.length;
  if(!items.length){
    document.getElementById('portareContent').innerHTML=`<div style="background:white"><div class="empty"><div class="empty-icon">üè†</div><div class="empty-text">Nessun prodotto da portare</div><div class="empty-sub">I prodotti mancanti/scarsi senza flag<br>"Da acquistare" appariranno qui</div></div></div>`;
    return;
  }
  // Raggruppa per categoria
  let html='';
  const cats = [...new Set(items.map(p=>p.cat))];
  cats.forEach(catId=>{
    const cat=getCat(catId);
    const catItems=items.filter(p=>p.cat===catId).sort((a,b)=>({out:0,low:1,ok:2}[a.status]-{out:0,low:1,ok:2}[b.status]));
    html+=`<div class="spesa-group">
      <div class="spesa-group-header" style="display:flex;align-items:center;gap:8px">
        <span style="font-size:16px">${cat.icon}</span> ${cat.name.toUpperCase()}
      </div>`;
    html+=catItems.map(p=>{
      const icon=p.status==='out'?'‚ùå':'‚ö†Ô∏è';
      return `<div class="spesa-item">
        <div class="checkbox" id="pchk-${p.id}" onclick="togglePortareCheck(${p.id},this)"></div>
        <div style="flex:1">
          <div class="spesa-name" id="pname-${p.id}">${icon} ${p.name}</div>
          <div class="spesa-cat">${p.qty?' Qt√†: '+p.qty+' ¬∑':''} ${p.status==='out'?'Mancante':'Scarso'}</div>
        </div>
        <div class="spesa-del" onclick="openEditModal(${p.id})">‚úèÔ∏è</div>
      </div>`;
    }).join('');
    html+='</div>';
  });
  document.getElementById('portareContent').innerHTML=html;
}

function togglePortareCheck(pid,el){
  el.classList.toggle('checked'); el.textContent=el.classList.contains('checked')?'‚úì':'';
  const n=document.getElementById('pname-'+pid); if(n) n.classList.toggle('done');
}

function setToggleUI(active){
  currentDisabled = !active;
  const sw = document.getElementById('toggleSwitch');
  const kn = document.getElementById('toggleKnob');
  const lb = document.getElementById('disabledToggleLabel');
  if(active){
    sw.style.background='var(--green)';
    kn.style.left='23px';
    lb.textContent='Prodotto attivo';
    lb.style.color='var(--text)';
  } else {
    sw.style.background='var(--text3)';
    kn.style.left='3px';
    lb.textContent='Prodotto disattivato';
    lb.style.color='var(--text3)';
  }
}

function toggleDisabled(){
  setToggleUI(currentDisabled); // flip
}

function selectStatus(s,el){
  selectedStatus=s;
  ['ok','low','out'].forEach(x=>document.getElementById('sopt-'+x).className='status-opt');
  el.className='status-opt sel-'+s;
}

// ‚îÄ‚îÄ MODAL CATEGORIA ‚îÄ‚îÄ
const CAT_COLORS = ['#FF6B6B','#4DA6FF','#A855F7','#06B6D4','#22C55E','#F59E0B','#6B7280','#8B5CF6','#EC4899','#10B981'];
const CAT_BGS =    ['#fff0f0','#f0f6ff','#faf0ff','#f0fbff','#f0fdf4','#fffbeb','#f3f4f6','#f5f3ff','#fdf2f8','#ecfdf5'];

function openCatModal(id){
  isNewCat=false; editingCatId=id;
  const cat=getCat(id);
  document.getElementById('catModalTitle').textContent='Modifica Categoria';
  document.getElementById('cf-name').value=cat.name;
  document.getElementById('cf-icon-preview').textContent=cat.icon;
  selectedEmoji=cat.icon;
  buildEmojiGrid(cat.icon);
  // Mostra elimina solo se la categoria non √® predefinita
  const isDefault = DEFAULT_CATEGORIES.some(d=>d.id===id);
  document.getElementById('deleteCatBtnRow').style.display = isDefault ? 'none' : 'block';
  openModal('catModalOverlay');
}

function openNewCatModal(){
  isNewCat=true; editingCatId=null;
  document.getElementById('catModalTitle').textContent='Nuova Categoria';
  document.getElementById('cf-name').value='';
  document.getElementById('cf-icon-preview').textContent='üì¶';
  selectedEmoji='üì¶';
  buildEmojiGrid('üì¶');
  document.getElementById('deleteCatBtnRow').style.display='none';
  openModal('catModalOverlay');
}

function buildEmojiGrid(selected){
  document.getElementById('emojiGrid').innerHTML=EMOJIS.map(e=>
    `<div class="emoji-opt${e===selected?' sel':''}" onclick="pickEmoji('${e}',this)">${e}</div>`
  ).join('');
}

function pickEmoji(e,el){
  selectedEmoji=e;
  document.querySelectorAll('.emoji-opt').forEach(x=>x.classList.remove('sel'));
  el.classList.add('sel');
  document.getElementById('cf-icon-preview').textContent=e;
}

function saveCat(){
  const name=document.getElementById('cf-name').value.trim();
  if(!name) return;
  if(isNewCat){
    const idx=categories.length % CAT_COLORS.length;
    const newId='cat_'+Date.now();
    categories.push({id:newId, name, icon:selectedEmoji||'üì¶', color:CAT_COLORS[idx], bg:CAT_BGS[idx]});
  } else {
    const cat=categories.find(c=>c.id===editingCatId);
    if(cat){ cat.name=name; if(selectedEmoji) cat.icon=selectedEmoji; }
  }
  save(); closeModal('catModalOverlay');
  renderSettings();
  if(currentTab==='inventario') renderInventario();
}

function deleteCat(){
  if(products.some(p=>p.cat===editingCatId)){
    alert('Non puoi eliminare una categoria che contiene prodotti.\nSposta o elimina prima i prodotti.'); return;
  }
  if(!confirm('Eliminare questa categoria?')) return;
  categories=categories.filter(c=>c.id!==editingCatId);
  save(); closeModal('catModalOverlay'); renderSettings();
  if(currentTab==='inventario') renderInventario();
}

// ‚îÄ‚îÄ MODAL UTILS ‚îÄ‚îÄ
function openModal(id){
  const el=document.getElementById(id);
  el.style.display='flex';
  requestAnimationFrame(()=>requestAnimationFrame(()=>el.classList.add('open')));
  el.onclick=e=>{ if(e.target===el) closeModal(id); };
}
function closeModal(id){
  const el=document.getElementById(id);
  el.classList.remove('open');
  setTimeout(()=>{ el.style.display='none'; },280);
}

// ‚îÄ‚îÄ EXPORT/IMPORT ‚îÄ‚îÄ
function exportData(){
  const b=new Blob([JSON.stringify({products,spesaManuale,categories,date:new Date().toISOString()},null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='camper-dispensa.json'; a.click();
}
function importTrigger(){ document.getElementById('importFile').click(); }
function importData(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const d=JSON.parse(ev.target.result);
      if(d.products) products=d.products;
      if(d.spesaManuale) spesaManuale=d.spesaManuale;
      if(d.categories) categories=d.categories;
      save(); alert('Importazione completata!'); switchTab('inventario');
    }catch(err){alert('File non valido');}
  };
  r.readAsText(f); e.target.value='';
}
function resetAll(){
  if(!confirm('Eliminare TUTTI i dati e ripristinare i valori predefiniti?')) return;
  localStorage.removeItem('cd_products');
  localStorage.removeItem('cd_spesa');
  localStorage.removeItem('cd_categories');
  localStorage.removeItem('cd_valigie');
  localStorage.removeItem('cd_valigie_prod');
  localStorage.removeItem('cd_persone');
  load(); renderInventario();
}

// ‚îÄ‚îÄ VALIGIE ‚îÄ‚îÄ
function getValigia(id){ return valigie.find(v=>v.id===id); }
function getPersona(id){ return persone.find(p=>p.id===id); }
function getCurrentPersona(){ return getPersona(currentPersonaId)||persone[0]; }
function getVProd(id){ return valigieProdotti.find(p=>p.id===id); }
function getVProdForValigia(vid){ return valigieProdotti.filter(p=>p.valigie&&p.valigie.some(v=>(typeof v==='string'?v:v.id)===vid)); }
function getVEntry(p, vid){ return p.valigie.find(v=>(typeof v==='string'?v:v.id)===vid)||{id:vid,qty:''}; }
function isVPDisabled(p, personaId){ 
  if(!p.disabled) return false;
  if(typeof p.disabled === 'boolean') return p.disabled;
  return !!p.disabled[personaId||currentPersonaId];
}
function setVPDisabled(p, personaId, val){
  if(!p.disabled || typeof p.disabled === 'boolean') p.disabled = {};
  p.disabled[personaId||currentPersonaId] = val;
}
function getVPStatus(p, personaId){
  const pid = personaId||currentPersonaId;
  if(!p.status) return 'ok';
  if(typeof p.status === 'string') return p.status; // compatibilit√† vecchi dati
  return p.status[pid]||'ok';
}
function setVPStatus(p, personaId, val){
  if(!p.status || typeof p.status === 'string'){
    const old = typeof p.status === 'string' ? p.status : 'ok';
    p.status = {};
    // propaga lo stato vecchio a tutte le persone esistenti
    persone.forEach(pe=>{ p.status[pe.id] = old; });
  }
  p.status[personaId||currentPersonaId] = val;
}

function setValigieView(v, el){
  currentValigieView=v;
  document.querySelectorAll('#view-valigie .top-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('subview-valigie-lista').classList.toggle('hidden', v!=='lista');
  document.getElementById('subview-valigie-mancanti').classList.toggle('hidden', v!=='mancanti');
  renderValigie();
}

function renderPersonaTabs(){
  const bar = document.getElementById('personaTabs');
  bar.innerHTML = persone.filter(p=>!p.disabled).map(p=>{
    const active = p.id===currentPersonaId;
    return `<div onclick="switchPersona('${p.id}')" style="padding:6px 14px;border-radius:20px;font-size:13px;font-weight:800;cursor:pointer;white-space:nowrap;background:${active?p.colore:'var(--bg)'};color:${active?'#fff':'var(--text2)'};border:1.5px solid ${active?p.colore:'var(--border)'};transition:all .15s;">${p.nome}</div>`;
  }).join('');
  // Se la persona corrente √® disattivata, passa alla prima attiva
  const currActive = persone.find(p=>!p.disabled);
  if(currActive && persone.find(p=>p.id===currentPersonaId)?.disabled){
    currentPersonaId = currActive.id;
  }
}

function switchPersona(pid){
  currentPersonaId = pid;
  renderValigie();
}

function renderValigie(){
  renderPersonaTabs();
  const myValigie = valigie.filter(v=>v.personaId===currentPersonaId);
  const currP = getCurrentPersona();
  if(currP && currP.disabled){
    document.getElementById('valigieHeroNum').textContent = 'üîï';
    document.getElementById('valigieHeroSub').textContent = currP.nome+' √® disattivata';
    document.getElementById('subview-valigie-lista').innerHTML = '<div style="background:white"><div class="empty"><div class="empty-icon">üîï</div><div class="empty-text">'+currP.nome+' disattivata</div><div class="empty-sub">Riattivala dal tasto ‚öôÔ∏è per vedere le valigie</div></div></div>';
    document.getElementById('subview-valigie-mancanti').innerHTML = '';
    return;
  }
  const active = myValigie.filter(v=>v.active);
  const persona = getCurrentPersona();
  document.getElementById('valigieHeroNum').textContent = currP ? currP.nome : 'üß≥';
  document.getElementById('valigieHeroSub').textContent = active.length > 0
    ? (active.length===1 ? '1 valigia attiva' : active.length+' valigie attive')
    : 'nessuna valigia attiva';

  if(currentValigieView==='lista') renderValigieList();
  else renderValigeMancanti();
}

function renderValigieList(){
  const el=document.getElementById('valigieList');
  el.innerHTML = valigie.filter(v=>v.personaId===currentPersonaId).map(v=>{
    const prods=getVProdForValigia(v.id);
    const tot=prods.length;
    const ok=prods.filter(p=>getVPStatus(p,currentPersonaId)==='ok').length;
    const miss=prods.filter(p=>getVPStatus(p,currentPersonaId)!=='ok').length;
    const pct=tot>0?Math.round(ok/tot*100):100;
    const toggleBg=v.active?'var(--green)':'var(--text3)';
    const knobLeft=v.active?'23px':'3px';
    const bodyHtml=v.active?`
      <div class="valigia-products" id="vprod-${v.id}">
        ${renderValigiaProdList(v.id)}
      </div>
      <div style="display:flex;border-top:1px solid var(--border)">
        <div onclick="openNewVProdModal('${v.id}')" class="add-to-valigia-btn" style="flex:1;border-right:1px solid var(--border)">
          ‚ûï Aggiungi prodotto
        </div>
        <div onclick="openEditValigiaModal('${v.id}')" class="add-to-valigia-btn" style="flex:0;padding:12px 16px;color:var(--text3)">
          ‚úèÔ∏è
        </div>
      </div>`:`
      <div onclick="openEditValigiaModal('${v.id}')" style="display:flex;align-items:center;justify-content:flex-end;padding:8px 14px;border-top:1px solid var(--border)">
        <span style="font-size:12px;color:var(--text3);font-weight:700;cursor:pointer;">‚úèÔ∏è Modifica</span>
      </div>`;
    return `<div class="valigia-card">
      <div class="valigia-header" onclick="toggleValigiaActive('${v.id}')">
        <div class="valigia-icon" style="background:${v.bg}">${v.icon}</div>
        <div class="valigia-info">
          <div class="valigia-name">${v.name}</div>
          <div class="valigia-meta">${tot} prodotti ¬∑ ${ok} ok ¬∑ ${miss} mancanti ¬∑ ${pct}% pronta</div>
        </div>
        <div class="valigia-toggle" style="background:${toggleBg}">
          <div class="valigia-knob" style="left:${knobLeft}"></div>
        </div>
      </div>
      ${bodyHtml}
    </div>`;
  }).join('');
}

function renderValigiaProdList(vid){
  const prods=getVProdForValigia(vid);
  if(!prods.length) return '<div class="empty" style="padding:20px"><div class="empty-text">Valigia vuota</div></div>';
  const sorted=[...prods].sort((a,b)=>({out:0,low:1,ok:2}[getVPStatus(a,currentPersonaId)]-{out:0,low:1,ok:2}[getVPStatus(b,currentPersonaId)]));
  return sorted.map(p=>{
    const pStatus = getVPStatus(p, currentPersonaId);
    const dc=pStatus==='ok'?'dot-ok':pStatus==='low'?'dot-low':'dot-out';
    const sc=pStatus==='ok'?'sl-ok':pStatus==='low'?'sl-low':'sl-out';
    const sl=pStatus==='ok'?'OK':pStatus==='low'?'Scarso':'Mancante';
    const entry=getVEntry(p,vid);
    const qtyLabel=entry.qty?`<span style="font-size:12px;font-weight:800;color:var(--text2);margin-left:4px">√ó ${entry.qty}</span>`:'';
    const valigieNames=p.valigie.filter(vi=>(typeof vi==='string'?vi:vi.id)!==vid).map(vi=>{const id=typeof vi==='string'?vi:vi.id;const vv=getValigia(id);return vv?vv.icon:'';}).join('');
    const isPDis = isVPDisabled(p, currentPersonaId);
    return `<div class="valigia-prod-item${isPDis?' disabled':''}" onclick="openEditVProdModal('${p.id}','${vid}')">
      <div class="status-dot ${dc}"></div>
      <div style="flex:1;min-width:0">
        <div class="valigia-prod-name">${p.name}${qtyLabel} ${valigieNames?'<span style="font-size:11px;color:var(--text3)">anche in: '+valigieNames+'</span>':''}</div>
        ${p.note?`<div class="valigia-prod-note">${p.note}</div>`:''}
      </div>
      <div class="valigia-prod-status ${sc}">${sl}</div>
    </div>`;
  }).join('');
}

function renderValigeMancanti(){
  const activeValigie=valigie.filter(v=>v.active&&v.personaId===currentPersonaId);
  const el=document.getElementById('valigieMancantiContent');
  if(!activeValigie.length){
    el.innerHTML=`<div style="background:white"><div class="empty"><div class="empty-icon">üß≥</div><div class="empty-text">Nessuna valigia attiva</div><div class="empty-sub">Attiva almeno una valigia per vedere<br>i prodotti da preparare</div></div></div>`;
    return;
  }
  let html='';
  activeValigie.forEach(v=>{
    const missing=getVProdForValigia(v.id).filter(p=>getVPStatus(p,currentPersonaId)!=='ok'&&!isVPDisabled(p,currentPersonaId));
    if(!missing.length) return;
    html+=`<div class="spesa-group">
      <div class="spesa-group-header" style="display:flex;align-items:center;gap:8px">
        <span style="font-size:16px">${v.icon}</span> ${v.name.toUpperCase()} ‚Äî ${missing.length} DA PREPARARE
      </div>`;
    html+=missing.map(p=>`<div class="spesa-item">
      <div class="checkbox" id="vmchk-${v.id}-${p.id}" onclick="toggleVMCheck('${v.id}','${p.id}',this)"></div>
      <div style="flex:1">
        <div class="spesa-name" id="vmname-${v.id}-${p.id}">${getVPStatus(p,currentPersonaId)==='out'?'‚ùå':'‚ö†Ô∏è'} ${p.name}</div>
        <div class="spesa-cat">${p.note||''}</div>
      </div>
      <div class="spesa-del" onclick="openEditVProdModal('${p.id}','${v.id}')">‚úèÔ∏è</div>
    </div>`).join('');
    html+='</div>';
  });
  if(!html) html=`<div style="background:white"><div class="empty"><div class="empty-icon">‚úÖ</div><div class="empty-text">Tutto a posto!</div><div class="empty-sub">Le valigie attive sono pronte</div></div></div>`;
  el.innerHTML=html;
}

function toggleVMCheck(vid,pid,el){
  el.classList.toggle('checked'); el.textContent=el.classList.contains('checked')?'‚úì':'';
  const n=document.getElementById('vmname-'+vid+'-'+pid); if(n) n.classList.toggle('done');
}

function toggleValigiaActive(id){
  const v=getValigia(id); if(!v) return;
  v.active=!v.active;
  save(); renderValigie();
}

// ‚îÄ‚îÄ GESTIONE PERSONE ‚îÄ‚îÄ
const PERSONA_COLORS = ['#e17055','#4DA6FF','#00b894','#A855F7','#F59E0B','#EC4899','#06B6D4','#22C55E'];
const PERSONA_BGS    = ['#fff3f0','#f0f6ff','#e8f8f3','#faf0ff','#fffbeb','#fdf2f8','#f0fbff','#f0fdf4'];
let selectedPersonaColor = PERSONA_COLORS[0];
let personaCurrentDisabled = false;

function setPersonaToggleUI(active){
  personaCurrentDisabled = !active;
  const sw = document.getElementById('peToggleSwitch');
  const kn = document.getElementById('peToggleKnob');
  const lb = document.getElementById('peDisabledLabel');
  if(active){
    sw.style.background='var(--green)'; kn.style.left='23px';
    lb.textContent='Persona attiva'; lb.style.color='var(--text)';
  } else {
    sw.style.background='var(--text3)'; kn.style.left='3px';
    lb.textContent='Persona disattivata'; lb.style.color='var(--text3)';
  }
}

function togglePersonaDisabled(){ setPersonaToggleUI(personaCurrentDisabled); }

function openPersonaManager(){
  const list = document.getElementById('personaManagerList');
  list.innerHTML = persone.map(p=>`
    <div style="display:flex;align-items:center;gap:12px;background:var(--bg);border-radius:12px;padding:12px 14px;">
      <div style="width:36px;height:36px;border-radius:50%;background:${p.colore};display:flex;align-items:center;justify-content:center;color:#fff;font-size:16px;font-weight:900;flex-shrink:0">${p.nome[0].toUpperCase()}</div>
      <div style="flex:1;font-size:14px;font-weight:700">${p.nome}</div>
      <div onclick="openEditPersonaModal('${p.id}')" style="padding:6px 12px;border-radius:8px;background:var(--white);border:1.5px solid var(--border);font-size:12px;font-weight:700;cursor:pointer;">‚úèÔ∏è Modifica</div>
    </div>`).join('');
  openModal('personaManagerOverlay');
}

function openNewPersonaModal(){
  editingPersonaId = null;
  document.getElementById('personaEditTitle').textContent = 'Nuova Persona';
  document.getElementById('pe-nome').value = '';
  document.getElementById('deletePersonaBtnRow').style.display = 'none';
  document.getElementById('pe-copia-row').style.display = 'block';
  document.getElementById('pe-disabled-row').style.display = 'none';
  document.getElementById('pe-copia-da').innerHTML = '<option value="">‚Äî Non copiare ‚Äî</option>' +
    persone.map(p=>`<option value="${p.id}">${p.nome}</option>`).join('');
  selectedPersonaColor = PERSONA_COLORS[persone.length % PERSONA_COLORS.length];
  buildPersonaColorPicker();
  closeModal('personaManagerOverlay');
  openModal('personaEditOverlay');
  setTimeout(()=>document.getElementById('pe-nome').focus(), 350);
}

function openEditPersonaModal(id){
  editingPersonaId = id;
  const p = getPersona(id); if(!p) return;
  document.getElementById('personaEditTitle').textContent = 'Modifica Persona';
  document.getElementById('pe-nome').value = p.nome;
  document.getElementById('pe-copia-row').style.display = 'none';
  document.getElementById('deletePersonaBtnRow').style.display = persone.length > 1 ? 'block' : 'none';
  selectedPersonaColor = p.colore;
  buildPersonaColorPicker();
  setPersonaToggleUI(!p.disabled);
  document.getElementById('pe-disabled-row').style.display = 'block';
  closeModal('personaManagerOverlay');
  openModal('personaEditOverlay');
}

function buildPersonaColorPicker(){
  document.getElementById('pe-colori').innerHTML = PERSONA_COLORS.map((c,i)=>
    `<div onclick="selectPersonaColor('${c}')" id="pcolor-${i}" style="width:32px;height:32px;border-radius:50%;background:${c};cursor:pointer;border:3px solid ${c===selectedPersonaColor?'var(--text)':'transparent'};transition:border .15s;"></div>`
  ).join('');
}

function selectPersonaColor(c){
  selectedPersonaColor = c;
  buildPersonaColorPicker();
}

function savePersona(){
  const nome = document.getElementById('pe-nome').value.trim(); if(!nome) return;
  const copiaDa = document.getElementById('pe-copia-da') ? document.getElementById('pe-copia-da').value : '';
  if(editingPersonaId){
    const p = getPersona(editingPersonaId);
    if(p){ p.nome = nome; p.colore = selectedPersonaColor; p.bg = PERSONA_BGS[PERSONA_COLORS.indexOf(selectedPersonaColor)]||'#f5f6fa'; p.disabled = personaCurrentDisabled; }
  } else {
    const newId = 'p_'+Date.now();
    const idx = PERSONA_COLORS.indexOf(selectedPersonaColor);
    persone.push({id:newId, nome, colore:selectedPersonaColor, bg:PERSONA_BGS[idx]||'#f5f6fa'});
    // Copia valigie se richiesto
    if(copiaDa){
      const valigieSource = valigie.filter(v=>v.personaId===copiaDa);
      valigieSource.forEach(v=>{
        const newVId = 'v_'+Date.now()+'_'+Math.random().toString(36).substr(2,5);
        valigie.push({...v, id:newVId, personaId:newId, active:false});
        // I prodotti sono condivisi (stessi oggetti), nessuna copia necessaria
        // ma aggiungiamo l'associazione con la nuova valigia
        valigieProdotti.forEach(p=>{
          const hasOld = p.valigie.some(e=>(typeof e==='string'?e:e.id)===v.id);
          if(hasOld){
            p.valigie.push({id:newVId, qty: (p.valigie.find(e=>(typeof e==='string'?e:e.id)===v.id)||{qty:''}).qty});
          }
        });
      });
    }
    currentPersonaId = newId;
  }
  save(); closeModal('personaEditOverlay'); renderValigie();
}

function deletePersona(){
  if(persone.length<=1){ alert('Non puoi eliminare l\'unica persona.'); return; }
  if(!confirm('Eliminare questa persona e tutte le sue valigie?')) return;
  // Rimuovi valigie della persona
  const myVIds = valigie.filter(v=>v.personaId===editingPersonaId).map(v=>v.id);
  valigie = valigie.filter(v=>v.personaId!==editingPersonaId);
  // Rimuovi associazioni prodotti
  valigieProdotti.forEach(p=>{
    p.valigie = p.valigie.filter(e=>(typeof e==='string'?e:e.id) && !myVIds.includes(typeof e==='string'?e:e.id));
  });
  persone = persone.filter(p=>p.id!==editingPersonaId);
  if(currentPersonaId===editingPersonaId) currentPersonaId = persone[0].id;
  save(); closeModal('personaEditOverlay'); renderValigie();
}

// Modal valigia
const V_EMOJIS=['üß≥','üéí','üëú','üíº','üèñÔ∏è','‚ùÑÔ∏è','üå∏','üçÇ','‚òÄÔ∏è','üèïÔ∏è','‚úàÔ∏è','üö¢','üèîÔ∏è','üåä','üéø','‚õ∑Ô∏è','üèÑ','ü§ø','üé≠','üé™'];

function openNewValigiaModal(){
  editingValigiaId=null;
  document.getElementById('valigiaModalTitle').textContent='Nuova Valigia';
  document.getElementById('vm-name').value='';
  document.getElementById('vm-icon-preview').textContent='üß≥';
  selectedEmoji='üß≥';
  document.getElementById('valigiaEmojiGrid').innerHTML=V_EMOJIS.map(e=>
    `<div class="emoji-opt${e==='üß≥'?' sel':''}" onclick="pickVEmoji('${e}',this)">${e}</div>`).join('');
  document.getElementById('deleteValigiaBtnRow').style.display='none';
  openModal('valigiaModalOverlay');
  setTimeout(()=>document.getElementById('vm-name').focus(),350);
}

function openEditValigiaModal(id){
  editingValigiaId=id;
  const v=getValigia(id); if(!v) return;
  document.getElementById('valigiaModalTitle').textContent='Modifica Valigia';
  document.getElementById('vm-name').value=v.name;
  document.getElementById('vm-icon-preview').textContent=v.icon;
  selectedEmoji=v.icon;
  document.getElementById('valigiaEmojiGrid').innerHTML=V_EMOJIS.map(e=>
    `<div class="emoji-opt${e===v.icon?' sel':''}" onclick="pickVEmoji('${e}',this)">${e}</div>`).join('');
  document.getElementById('deleteValigiaBtnRow').style.display='block';
  openModal('valigiaModalOverlay');
}

function pickVEmoji(e,el){
  selectedEmoji=e;
  document.querySelectorAll('#valigiaEmojiGrid .emoji-opt').forEach(x=>x.classList.remove('sel'));
  el.classList.add('sel');
  document.getElementById('vm-icon-preview').textContent=e;
}

function saveValigia(){
  const name=document.getElementById('vm-name').value.trim(); if(!name) return;
  const VCOLORS=['#4DA6FF','#FF6B6B','#22C55E','#F59E0B','#06B6D4','#A855F7','#EC4899','#10B981'];
  const VBGS=['#f0f6ff','#fff0f0','#f0fdf4','#fffbeb','#f0fbff','#faf0ff','#fdf2f8','#ecfdf5'];
  if(editingValigiaId){
    const v=getValigia(editingValigiaId);
    if(v){ v.name=name; v.icon=selectedEmoji||v.icon; }
  } else {
    const idx=valigie.length%VCOLORS.length;
    valigie.push({id:'v_'+Date.now(),name,icon:selectedEmoji||'üß≥',color:VCOLORS[idx],bg:VBGS[idx],active:false,personaId:currentPersonaId});
  }
  save(); closeModal('valigiaModalOverlay'); renderValigie();
}

function deleteValigia(){
  if(!confirm('Eliminare questa valigia e tutti i suoi prodotti?')) return;
  valigie=valigie.filter(v=>v.id!==editingValigiaId);
  save(); closeModal('valigiaModalOverlay'); renderValigie();
}

// Modal prodotto valigia
let vpCurrentDisabled = false;

function setVPToggleUI(active){
  vpCurrentDisabled = !active;
  const sw=document.getElementById('vpToggleSwitch');
  const kn=document.getElementById('vpToggleKnob');
  const lb=document.getElementById('vpDisabledLabel');
  if(active){
    sw.style.background='var(--green)'; kn.style.left='23px';
    lb.textContent='Prodotto attivo'; lb.style.color='var(--text)';
  } else {
    sw.style.background='var(--text3)'; kn.style.left='3px';
    lb.textContent='Prodotto disattivato'; lb.style.color='var(--text3)';
  }
}

function toggleVPDisabled(){ setVPToggleUI(vpCurrentDisabled); }

function buildValigieProdChecks(selectedEntries){
  // selectedEntries: array di {id, qty} oppure array di id stringa (compatibilit√†)
  const normalize = e => typeof e==='string' ? {id:e,qty:''} : e;
  const entries = selectedEntries.map(normalize);
  const selectedIds = entries.map(e=>e.id);
  document.getElementById('vp-valigie-checks').innerHTML = valigie.map(v=>{
    const checked = selectedIds.includes(v.id);
    const qty = (entries.find(e=>e.id===v.id)||{qty:''}).qty||'';
    return `<div style="display:flex;align-items:center;gap:8px;background:var(--bg);border-radius:10px;padding:8px 12px;border:1.5px solid ${checked?'var(--accent)':'var(--border)'}" id="vplabel-${v.id}">
      <div onclick="toggleVPCheck('${v.id}')" style="width:22px;height:22px;border-radius:6px;background:${checked?'var(--accent)':'transparent'};border:2px solid ${checked?'var(--accent)':'var(--border)'};display:flex;align-items:center;justify-content:center;color:white;font-size:13px;font-weight:900;flex-shrink:0;cursor:pointer" id="vpcheck-${v.id}">${checked?'‚úì':''}</div>
      <span onclick="toggleVPCheck('${v.id}')" style="font-size:14px;font-weight:700;flex:1;cursor:pointer">${v.icon} ${v.name}</span>
      <input type="number" min="0" id="vpqty-${v.id}" value="${qty}" placeholder="qt√†" 
        style="width:56px;padding:5px 8px;border-radius:8px;border:1.5px solid var(--border);font-family:var(--font);font-size:13px;font-weight:700;color:var(--text);background:var(--white);text-align:center;outline:none;display:${checked?'block':'none'}"
        onclick="event.stopPropagation()" oninput="event.stopPropagation()">
    </div>`;
  }).join('');
}

function toggleVPCheck(vid){
  const lbl=document.getElementById('vplabel-'+vid);
  const chk=document.getElementById('vpcheck-'+vid);
  const qty=document.getElementById('vpqty-'+vid);
  const isChecked=chk.textContent==='‚úì';
  chk.textContent=isChecked?'':'‚úì';
  chk.style.background=isChecked?'transparent':'var(--accent)';
  chk.style.borderColor=isChecked?'var(--border)':'var(--accent)';
  lbl.style.borderColor=isChecked?'var(--border)':'var(--accent)';
  if(qty) qty.style.display=isChecked?'none':'block';
}

function getCheckedValigie(){
  return valigie
    .filter(v=>document.getElementById('vpcheck-'+v.id)&&document.getElementById('vpcheck-'+v.id).textContent==='‚úì')
    .map(v=>({id:v.id, qty:(document.getElementById('vpqty-'+v.id)||{value:''}).value.trim()}));
}

function openNewVProdModal(valigiaId){
  editingVProdId=null; editingVProdValigiaId=valigiaId;
  document.getElementById('vProdModalTitle').textContent='Nuovo Prodotto';
  document.getElementById('vp-name').value='';
  document.getElementById('vp-note').value='';
  document.getElementById('deleteVProdBtnRow').style.display='none';
  document.getElementById('vpDisabledToggleRow').style.display='none';
  selectVPStatus('ok',document.getElementById('vpsopt-ok'));
  buildValigieProdChecks([{id:valigiaId,qty:''}]);
  openModal('vProdModalOverlay');
  setTimeout(()=>document.getElementById('vp-name').focus(),350);
}

function openEditVProdModal(prodId, valigiaId){
  editingVProdId=prodId; editingVProdValigiaId=valigiaId;
  const p=getVProd(prodId); if(!p) return;
  document.getElementById('vProdModalTitle').textContent='Modifica Prodotto';
  document.getElementById('vp-name').value=p.name;
  document.getElementById('vp-note').value=p.note||'';
  const pStat = getVPStatus(p, currentPersonaId);
  selectVPStatus(pStat,document.getElementById('vpsopt-'+pStat));
  buildValigieProdChecks(p.valigie&&p.valigie.length ? p.valigie : [{id:valigiaId,qty:''}]);
  document.getElementById('deleteVProdBtnRow').style.display='block';
  document.getElementById('vpDisabledToggleRow').style.display='block';
  setVPToggleUI(!isVPDisabled(p, currentPersonaId));
  openModal('vProdModalOverlay');
}

function selectVPStatus(s,el){
  selectedVPStatus=s;
  ['ok','low','out'].forEach(x=>document.getElementById('vpsopt-'+x).className='status-opt');
  el.className='status-opt sel-'+s;
}

function saveVProd(){
  const name=document.getElementById('vp-name').value.trim(); if(!name) return;
  const note=document.getElementById('vp-note').value.trim();
  const valigieSelezionate=getCheckedValigie();
  if(editingVProdId){
    const p=getVProd(editingVProdId);
    if(p){
      Object.assign(p,{name,note,valigie:valigieSelezionate});
      setVPStatus(p, currentPersonaId, selectedVPStatus);
      setVPDisabled(p, currentPersonaId, vpCurrentDisabled);
    }
  } else {
    const newP={id:'vp_'+Date.now(),name,note,status:{},valigie:valigieSelezionate,disabled:{}};
    setVPStatus(newP, currentPersonaId, selectedVPStatus);
    setVPDisabled(newP, currentPersonaId, false);
    valigieProdotti.push(newP);
  }
  save(); closeModal('vProdModalOverlay'); renderValigie();
}

function deleteVProd(){
  if(!confirm('Eliminare questo prodotto da tutte le valigie?')) return;
  valigieProdotti=valigieProdotti.filter(p=>p.id!==editingVProdId);
  save(); closeModal('vProdModalOverlay'); renderValigie();
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
document.getElementById('quickSpesaInput').addEventListener('keydown',e=>{if(e.key==='Enter')addManualSpesa();});
load();
renderInventario();
autoBackupIfNeeded();

function autoBackupIfNeeded(){
  const lastBackup = localStorage.getItem('cd_last_backup');
  const now = Date.now();
  const oneDay = 24 * 60 * 60 * 1000;
  if(!lastBackup || (now - parseInt(lastBackup)) > oneDay){
    const d = new Date();
    const dateStr = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
    const timeStr = String(d.getHours()).padStart(2,'0')+String(d.getMinutes()).padStart(2,'0');
    const filename = 'camper-dispensa-'+dateStr+'-'+timeStr+'.json';
    const data = JSON.stringify({products,spesaManuale,categories,valigie,valigieProdotti,persone,date:d.toISOString()},null,2);
    const blob = new Blob([data],{type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
    localStorage.setItem('cd_last_backup', now.toString());
    showToast('üì¶ Backup automatico salvato!');
  }
}

function showToast(msg){
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:#2d3436;color:#fff;padding:10px 20px;border-radius:20px;font-family:var(--font);font-size:13px;font-weight:700;z-index:9999;opacity:0;transition:opacity .3s;white-space:nowrap;box-shadow:0 4px 16px rgba(0,0,0,.2);';
  document.body.appendChild(t);
  requestAnimationFrame(()=>{ t.style.opacity='1'; });
  setTimeout(()=>{ t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 3000);
}
</script>
</body>
</html>
